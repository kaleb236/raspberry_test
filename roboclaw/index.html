<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Robot Joystick</title>

  <style>
    * {
      box-sizing: border-box;
      user-select: none;
      touch-action: none;
    }

    body {
      margin: 0;
      background: #0e0e0e;
      color: white;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
    }

    #joystick-container {
      position: relative;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: #1f1f1f;
      border: 3px solid #444;
    }

    #joystick {
      position: absolute;
      width: 80px;
      height: 80px;
      background: #00aaff;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(0,170,255,0.8);
    }

    #status {
      position: absolute;
      bottom: -45px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      color: #aaa;
    }
  </style>
</head>

<body>

<div id="joystick-container">
  <div id="joystick"></div>
  <div id="status">Connecting...</div>
</div>

<script>
  // ==========================
  // CONFIG
  // ==========================
  const WS_URL = "ws://localhost:8765"; // ðŸ”´ CHANGE THIS
  const MAX_LINEAR = 0.4;   // m/s
  const MAX_ANGULAR = 2.0;  // rad/s

  // ==========================
  // ELEMENTS
  // ==========================
  const container = document.getElementById("joystick-container");
  const joystick = document.getElementById("joystick");
  const status = document.getElementById("status");

  const containerRadius = container.clientWidth / 2;
  const knobRadius = joystick.clientWidth / 2;
  const maxRadius = containerRadius - knobRadius;

  let dragging = false;

  // ==========================
  // WEBSOCKET
  // ==========================
  const socket = new WebSocket(WS_URL);

  socket.onopen = () => status.innerText = "Connected";
  socket.onerror = () => status.innerText = "WebSocket Error";
  socket.onclose = () => status.innerText = "Disconnected";

  function sendCommand(linear, angular) {
    if (socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({
        linear_x: linear,
        angular_z: angular
      }));
    }
  }

  // ==========================
  // JOYSTICK LOGIC
  // ==========================
  function setKnob(x, y) {
    joystick.style.left = `${x - knobRadius}px`;
    joystick.style.top = `${y - knobRadius}px`;
  }

  function resetJoystick() {
    setKnob(containerRadius, containerRadius);
    sendCommand(0, 0);
  }

  function handleMove(e) {
    if (!dragging) return;

    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    let dx = x - containerRadius;
    let dy = y - containerRadius;

    const distance = Math.sqrt(dx * dx + dy * dy);

    // Clamp inside circle
    if (distance > maxRadius) {
      dx = (dx / distance) * maxRadius;
      dy = (dy / distance) * maxRadius;
    }

    const knobX = containerRadius + dx;
    const knobY = containerRadius + dy;

    setKnob(knobX, knobY);

    // Normalize [-1, 1]
    const normX = dx / maxRadius;
    const normY = dy / maxRadius;

    // Forward = up (negative Y)
    const linear = -normY * MAX_LINEAR;
    const angular = normX * MAX_ANGULAR;

    sendCommand(linear, angular);
  }

  // ==========================
  // EVENTS
  // ==========================
  container.addEventListener("pointerdown", (e) => {
    dragging = true;
    container.setPointerCapture(e.pointerId);
    handleMove(e);
  });

  container.addEventListener("pointermove", handleMove);

  container.addEventListener("pointerup", () => {
    dragging = false;
    resetJoystick();
  });

  container.addEventListener("pointercancel", resetJoystick);
  container.addEventListener("pointerleave", resetJoystick);

  // ==========================
  // INIT
  // ==========================
  resetJoystick();
</script>

</body>
</html>
